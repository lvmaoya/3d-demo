<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>全景展示 Demo</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    #thumbs {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 10;
      background: rgba(0,0,0,0.25);
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(6px);
      max-width: calc(100vw - 40px);
      overflow-x: auto;
    }
    #thumbs img {
      width: 96px;
      height: 56px;
      object-fit: cover;
      border-radius: 8px;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.25);
      opacity: 0.85;
      transition: transform .12s ease, opacity .12s ease, box-shadow .12s ease;
    }
    #thumbs img:hover { opacity: 1; transform: translateY(-1px); box-shadow: 0 6px 16px rgba(0,0,0,0.35); }
    #thumbs img.active { opacity: 1; border-color: rgba(2,132,199,0.8); box-shadow: 0 0 0 2px rgba(2,132,199,0.45); }
    canvas {
      display: block;
      width: 100vw;
      height: 100vh;
    }
  </style>
</head>
<body>
  <div id="thumbs"></div>
  <div id="loading" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);color:#fff;background:rgba(0,0,0,0.5);padding:12px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.15);">图片加载中…</div>
  <canvas id="c"></canvas>
  <script type="module">
    import * as THREE from 'https://esm.sh/three@0.159.0';
    import { OrbitControls } from 'https://esm.sh/three@0.159.0/examples/jsm/controls/OrbitControls.js';

    // 创建渲染器并绑定画布
    const canvas = document.getElementById('c');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

    // 场景与相机
    const scene = new THREE.Scene();
    // 视角，范围一般45-90，值越大视野越广、画布宽高比，匹配窗口避免拉伸、近裁剪面：距离相机小于此值的对象不渲染、远裁剪面：距离相机大于此值的对象不渲染
    const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
    camera.position.set(0, 0, 0.1);

    // 轨道控制器：仅允许旋转，不允许平移
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableZoom = false;
    controls.enablePan = false;
    controls.rotateSpeed = 0.3;
    controls.zoomSpeed = 0.5;
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;

    // 全景球体，贴图显示在球体内侧
    const geometry = new THREE.SphereGeometry(1, 64, 64);
    const material = new THREE.MeshBasicMaterial({ side: THREE.BackSide, transparent: true, opacity: 1 });
    const mesh = new THREE.Mesh(geometry, material);
    scene.add(mesh);
    const material2 = new THREE.MeshBasicMaterial({ side: THREE.BackSide, transparent: true, opacity: 0 });
    const mesh2 = new THREE.Mesh(geometry, material2);
    scene.add(mesh2);

    // 全景贴图路径
    const textures = [
      { id: 'pano1', src: 'assets/97b16f01995764d14ac91aa435604bec.jpg' },
      { id: 'pano2', src: 'assets/a98b0e5cee1b778588ae6b48e5643b72.jpg' },
      { id: 'pano3', src: 'assets/beea51b1dbe12ccd4f47349bc4489e1a.jpg' }
    ];

    // 纹理加载器与缓存引用
    const loader = new THREE.TextureLoader();
    const texCache = new Map();
    let currentId = null;
    let transition = null;

    // 统一配置纹理参数
    function setupTexture(t) {
      t.colorSpace = THREE.SRGBColorSpace;
      t.minFilter = THREE.LinearFilter;
      t.magFilter = THREE.LinearFilter;
      t.generateMipmaps = false;
      t.wrapS = THREE.RepeatWrapping;
      t.wrapT = THREE.ClampToEdgeWrapping;
      t.repeat.x = -1;
      t.offset.x = 1;
      t.anisotropy = renderer.capabilities.getMaxAnisotropy();
    }

    function applyTextureImmediate(t) {
      material.map = t;
      material.opacity = 1;
      material.needsUpdate = true;
      material2.opacity = 0;
      material2.map = null;
      document.getElementById('loading').style.display = 'none';
    }
    
    function crossfadeTo(t) {
      material2.map = t;
      material2.opacity = 0;
      material2.needsUpdate = true;
      transition = { start: performance.now(), duration: 300, target: t };
    }

    function loadTextureById(id, cb) {
      const info = textures.find(x => x.id === id);
      if (!info) return;
      if (texCache.has(id)) {
        cb && cb(texCache.get(id));
        return;
      }
      const t = loader.load(info.src, () => {
        setupTexture(t);
        texCache.set(id, t);
        cb && cb(t);
      });
    }

    function renderOnce() {
      renderer.render(scene, camera);
    }

    // 鼠标滚轮平滑缩放
    let fovTarget = camera.fov;
    const fovMin = 30, fovMax = 100, fovEase = 0.15;
    renderer.domElement.addEventListener('wheel', (e) => {
      e.preventDefault();
      const delta = -e.deltaY;
      fovTarget = THREE.MathUtils.clamp(fovTarget + delta * 0.05, fovMin, fovMax);
    }, { passive: false });

    function buildThumbs() {
      const wrap = document.getElementById('thumbs');
      wrap.innerHTML = '';
      textures.forEach((x, i) => {
        const img = document.createElement('img');
        img.src = x.src;
        img.alt = x.id;
        img.dataset.id = x.id;
        img.addEventListener('click', () => {
          document.querySelectorAll('#thumbs img').forEach(el => el.classList.remove('active'));
          img.classList.add('active');
          document.getElementById('loading').style.display = '';
          loadTextureById(x.id, (tex) => {
            if (currentId === null) {
              applyTextureImmediate(tex);
            } else {
              crossfadeTo(tex);
            }
            currentId = x.id;
          });
        });
        if (i === 0) img.classList.add('active');
        wrap.appendChild(img);
      });
    }
    buildThumbs();
    loadTextureById(textures[0].id, (tex) => { applyTextureImmediate(tex); currentId = textures[0].id; renderOnce(); });

    // 自适应窗口尺寸
    function resize() {
      const w = window.innerWidth;
      const h = window.innerHeight;
      renderer.setSize(w, h, false);
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
    }

    window.addEventListener('resize', resize);
    resize();

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      if (Math.abs(fovTarget - camera.fov) > 0.01) {
        camera.fov += (fovTarget - camera.fov) * fovEase;
        camera.fov = THREE.MathUtils.clamp(camera.fov, fovMin, fovMax);
        camera.updateProjectionMatrix();
      }
      if (transition) {
        const p = Math.min(1, (performance.now() - transition.start) / transition.duration);
        material.opacity = 1 - p;
        material2.opacity = p;
        if (p === 1) {
          material.map = transition.target;
          material.opacity = 1;
          material2.opacity = 0;
          material2.map = null;
          transition = null;
          document.getElementById('loading').style.display = 'none';
        }
      }
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
